<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Interfaces</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
            background: #f7f7f7;
        }

        h1 {
            color: #2c3e50;
        }

        #adapters {
            margin-top: 2em;
        }

        .adapter {
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 6px #0001;
            padding: 1em;
            margin-bottom: 1em;
        }

        .error {
            color: #c0392b;
        }

        .loader {
            color: #888;
        }

        .devices-list {
            margin-top: 1em;
        }

        .device {
            background: #eef6fa;
            border-left: 4px solid #3498db;
            margin: 0.5em 0 0.5em 1.5em;
            padding: 0.7em 1em;
            border-radius: 4px;
            box-shadow: 0 1px 3px #0001;
        }

        .device.paired {
            background: #dbeafe;
            /* pale blue */
            border-left-color: #60a5fa;
        }

        .device.unpaired {
            background: #fef9c3;
            /* pale yellow */
            border-left-color: #fde047;
        }

        .device.trusted {
            background: #93c5fd;
            /* deeper blue */
            border-left-color: #2563eb;
        }

        .device.connected {
            background: #bbf7d0;
            /* pale green */
            border-left-color: #22c55e;
        }
    </style>
</head>

<body>
    <h1>Bluetooth Interfaces</h1>
    <div id="adapters">
        <span class="loader">Loading...</span>
    </div>
    <!-- Devices will be shown under each adapter -->
    <script>
        async function fetchAdapters() {
            const adaptersDiv = document.getElementById('adapters');
            adaptersDiv.innerHTML = '<span class="loader">Loading...</span>';
            try {
                const resp = await fetch('/api/v1/bluetooth/adapters', { credentials: 'include' });
                if (!resp.ok) {
                    const err = await resp.json();
                    adaptersDiv.innerHTML = `<span class="error">Error: ${err.error || resp.statusText}</span>`;
                    return;
                }
                const data = await resp.json();
                if (!data.adapters || !data.adapters.length) {
                    adaptersDiv.innerHTML = '<span>No Bluetooth interface detected.</span>';
                    return;
                }
                adaptersDiv.innerHTML = '';
                for (const adapter of data.adapters) {
                    const div = document.createElement('div');
                    div.className = 'adapter';
                    const mac = adapter.address || adapter.Address || '';
                    // Scan/discoverable controls
                    div.innerHTML = `<b>Name:</b> ${adapter.name || adapter.address || 'Unknown'}<br><b>MAC:</b> ${mac}<br>
                        <span>Discoverable: <b style="color:${adapter.discoverable ? 'green' : 'red'}">${adapter.discoverable ? 'Yes' : 'No'}</b></span>
                        <button class="toggle-discoverable-btn" style="margin-left:0.5em;">Toggle</button>
                        <span>Scan: <b style="color:${adapter.discovering ? 'green' : 'red'}">${adapter.discovering ? 'Yes' : 'No'}</b></span>
                        <button class="toggle-discovering-btn" style="margin-left:0.5em;">Toggle</button>
                        <span class="scan-msg"></span>
                        <hr style="border:none;border-top:1px solid #d0d7de;margin:1em 0 0.5em 0;">
                        <div style="font-size:0.98em;color:#555;margin-bottom:0.5em;font-weight:bold;">Devices list</div>
                        <div class="devices-list"><span class="loader">Loading devices...</span></div>`;
                    adaptersDiv.appendChild(div);
                    // Toggle discoverable
                    const discoverableBtn = div.querySelector('.toggle-discoverable-btn');
                    discoverableBtn.onclick = async () => {
                        const msg = div.querySelector('.scan-msg');
                        msg.textContent = 'Updating...';
                        const resp = await fetch(`/api/v1/bluetooth/adapters/${mac}/discoverable`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ enable: !adapter.discoverable })
                        });
                        const res = await resp.json();
                        msg.textContent = resp.ok ? 'Discoverable updated!' : (res.error || 'Error');
                        if (resp.ok) setTimeout(fetchAdapters, 1000);
                    };
                    // Toggle discovering
                    const discoveringBtn = div.querySelector('.toggle-discovering-btn');
                    discoveringBtn.onclick = async () => {
                        const msg = div.querySelector('.scan-msg');
                        msg.textContent = 'Updating...';
                        const resp = await fetch(`/api/v1/bluetooth/adapters/${mac}/discovering`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ enable: !adapter.discovering })
                        });
                        const res = await resp.json();
                        msg.textContent = resp.ok ? 'Scan updated!' : (res.error || 'Error');
                        if (resp.ok) setTimeout(fetchAdapters, 1000);
                    };
                    fetchDevicesForAdapter(mac, div.querySelector('.devices-list'), div);
                }
            } catch (e) {
                adaptersDiv.innerHTML = `<span class="error">Network error: ${e}</span>`;
            }
        }

        async function fetchDevicesForAdapter(adapterMac, container, adapterDiv) {
            container.innerHTML = '<span class="loader">Loading...</span>';
            try {
                // All devices
                const resp = await fetch(`/api/v1/bluetooth/adapters/${adapterMac}/devices`, { credentials: 'include' });
                if (!resp.ok) {
                    container.innerHTML = `<span class="error">Error: ${resp.statusText}</span>`;
                    return;
                }
                const data = await resp.json();
                // Trusted devices
                const trustedResp = await fetch(`/api/v1/bluetooth/adapters/${adapterMac}/devices/trusted`, { credentials: 'include' });
                let trustedSet = new Set();
                if (trustedResp.ok) {
                    const trustedData = await trustedResp.json();
                    if (trustedData.trusted_devices && trustedData.trusted_devices.length) {
                        trustedData.trusted_devices.forEach(td => {
                            const tmac = td.address || td.Address || '';
                            if (tmac) trustedSet.add(tmac);
                        });
                    }
                }
                if (!data.devices || !data.devices.length) {
                    container.innerHTML = '<span>No device found.</span>';
                    return;
                }
                container.innerHTML = '';
                data.devices.forEach(device => {
                    const devDiv = document.createElement('div');
                    let classes = ['device'];
                    // Status logic
                    const isPaired = device.paired || device.Paired;
                    const isConnected = device.connected || device.Connected;
                    const isTrusted = trustedSet.has(device.address || device.Address || '');
                    if (isConnected) {
                        classes.push('connected');
                    } else if (isTrusted) {
                        classes.push('trusted');
                    } else if (isPaired) {
                        classes.push('paired');
                    } else {
                        classes.push('unpaired');
                    }
                    devDiv.className = classes.join(' ');
                    const mac = device.address || device.Address || '';
                    devDiv.innerHTML = `<b>Name:</b> ${device.name || device.Name || mac || 'Unknown'}<br><b>MAC:</b> ${mac}<br>
                        <span>Paired: <b style="color:${isPaired ? 'green' : 'red'}">${isPaired ? 'Yes' : 'No'}</b></span>
                        <span style="margin-left:1em;">Connected: <b style="color:${isConnected ? 'green' : 'red'}">${isConnected ? 'Yes' : 'No'}</b></span>
                        <span style="margin-left:1em;">Trusted: <b style="color:${isTrusted ? 'green' : 'red'}">${isTrusted ? 'Yes' : 'No'}</b></span>
                        <span class="device-msg"></span>`;
                    // Add (Pair) button if not paired
                    if (!isPaired) {
                        const pairBtn = document.createElement('button');
                        pairBtn.textContent = 'Pair';
                        pairBtn.className = 'pair-device-btn';
                        pairBtn.style.marginLeft = '1em';
                        pairBtn.onclick = async (e) => {
                            e.stopPropagation();
                            const msg = devDiv.querySelector('.device-msg');
                            msg.textContent = 'Pairing...';
                            const resp = await fetch(`/api/v1/bluetooth/adapters/${adapterMac}/devices/${mac}/pair`, {
                                method: 'POST', credentials: 'include'
                            });
                            const res = await resp.json();
                            msg.textContent = resp.ok ? 'Pairing initiated!' : (res.error || 'Error');
                            if (resp.ok) setTimeout(() => fetchDevicesForAdapter(adapterMac, container, adapterDiv), 1500);
                        };
                        devDiv.appendChild(pairBtn);
                    } else {
                        // Only show delete button for paired devices
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'delete-device-btn';
                        deleteBtn.style.marginLeft = '1em';
                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            if (!confirm('Are you sure you want to remove this device?')) return;
                            const msg = devDiv.querySelector('.device-msg');
                            msg.textContent = 'Removing...';
                            const resp = await fetch(`/api/v1/bluetooth/adapters/${adapterMac}/devices/${mac}`, {
                                method: 'DELETE', credentials: 'include'
                            });
                            const res = await resp.json();
                            msg.textContent = resp.ok ? 'Removed!' : (res.error || 'Error');
                            if (resp.ok) setTimeout(() => fetchDevicesForAdapter(adapterMac, container, adapterDiv), 1000);
                        };
                        devDiv.appendChild(deleteBtn);
                    }
                    container.appendChild(devDiv);
                });
            } catch (e) {
                container.innerHTML = `<span class="error">Network error: ${e}</span>`;
            }
        }
        fetchAdapters();
    </script>
</body>

</html>